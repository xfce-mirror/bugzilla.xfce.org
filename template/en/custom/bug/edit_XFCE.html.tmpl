[%# This Source Code Form is subject to the terms of the Mozilla Public
  # License, v. 2.0. If a copy of the MPL was not distributed with this
  # file, You can obtain one at http://mozilla.org/MPL/2.0/.
  #
  # This Source Code Form is "Incompatible With Secondary Licenses", as
  # defined by the Mozilla Public License, v. 2.0.
  #%]

[% PROCESS bug/time.html.tmpl %]

[% IF Param('comment_taggers_group') %]
  [% IF user.can_tag_comments %]
    <div id="bz_ctag_div" class="bz_default_hidden">
      <a href="javascript:void(0)" onclick="YAHOO.bugzilla.commentTagging.hideInput()">x</a>
      <div>
        <input id="bz_ctag_add" size="10" placeholder="add tag"
              maxlength="[% constants.MAX_COMMENT_TAG_LENGTH FILTER html %]">
        <span id="bz_ctag_autocomp"></span>
      </div>
      &nbsp;
    </div>
    <div id="bz_ctag_error" class="bz_default_hidden">
      <a href="javascript:void(0)" onclick="YAHOO.bugzilla.commentTagging.hideError()">x</a>
      <span id="bz_ctag_error_msg"></span>
    </div>
  [% END %]
  [% IF user.id %]
    <script type="text/javascript">
      YAHOO.bugzilla.commentTagging.init([% user.can_tag_comments ? 'true' : 'false' %]);
      YAHOO.bugzilla.commentTagging.min_len = [% constants.MIN_COMMENT_TAG_LENGTH FILTER js %];
      YAHOO.bugzilla.commentTagging.max_len = [% constants.MAX_COMMENT_TAG_LENGTH FILTER js %];
      YAHOO.bugzilla.commentTagging.label = 'Comment Tags:';
      YAHOO.bugzilla.commentTagging.min_len_error =
        'Comment tags must be at least
        [%~ " " _ constants.MIN_COMMENT_TAG_LENGTH FILTER js %] characters.';
      YAHOO.bugzilla.commentTagging.max_len_error =
        'Comment tags cannot be longer than
        [%~ " " _ constants.MAX_COMMENT_TAG_LENGTH FILTER js %] characters.';
    </script>
  [% END %]
[% END %]

<script type="text/javascript">
<!--
[% IF user.is_timetracker %]
  var bz_remaining_time = [% bug.remaining_time %];
[% END %]

[% IF user.id %]
  /* Index all classifications so we can keep track of the classification
   * for the selected product, which could control field visibility.
   */
  var all_classifications = new Array([% bug.choices.product.size %]);
  [%- FOREACH product = bug.choices.product %]
      all_classifications['[% product.name FILTER js %]'] = '
          [%- product.classification.name FILTER js %]';
  [%- END %]
[% END %]
//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="[% bug.delta_ts %]">
  <input type="hidden" name="id" value="[% bug.bug_id %]">
  <input type="hidden" name="token" value="[% issue_hash_token([bug.id, bug.delta_ts]) FILTER html %]">

  <div id="bug-header" class="group">
    <div id="bug-title">
      <div id="summary_container">
        <a href="show_bug.cgi?id=[% bug.bug_id %]" class="bug_title">
          <span id="short_desc_nonedit_display_custom">[% bug.short_desc FILTER quoteUrls(bug) %]</span>
        </a>
      </div>
      <div id="summary_input">
        [% PROCESS input inputname => "short_desc" size => "80"
                   maxlength => 255 spellcheck => "true" no_td => 1 %]
      </div>
      <script type="text/javascript">
        hideEditableField('summary_container',
                          'summary_input',
                          'summary_edit_action',
                          'short_desc',
                          '[% bug.short_desc FILTER js %]' );
      </script>
    </div>

    [% IF user.id %]
      <div id="bug-primary-actions">
        [% IF bug.check_can_change_field('short_desc', 0, 1) %]
          <a href="#" id="summary_edit_action" class="action-link">Edit title</a>
        [% END %]
        <input type="submit" value="Save Changes" id="commit_top">
      </div>
    [% END %]
  </div>

  <div id="bug-layout">
    <div id="bug-main">

      [%#                        #%]
      [%#    MAIN INFORMATION    #%]
      [%#                        #%]

      <div class="bug-row bug-flex" style="margin-top: 1em;">

        [%#    Status    #%]

        <div class="flex-item flex-status status status-[% bug.bug_status %]">
          [% INCLUDE "bug/field-label.html.tmpl"
              field = bug_fields.bug_status
              tag_name = 'b' %]
          <br />
          [% PROCESS bug/knob.html.tmpl %]
        </div>

        [%#    Priority    #%]

        [% can_edit_priority = bug.check_can_change_field('priority', 0, 1) %]
        <div class="flex-item">
          [% INCLUDE "bug/field-label.html.tmpl"
              field = bug_fields.priority
              tag_name = 'b' %]
          <br />
          <span class="select">
            [% INCLUDE bug/field.html.tmpl
              bug = bug, field = bug_fields.priority
              no_tds = 1, value = bug.priority
              override_legal_values = bug.choices.priority
              editable = can_edit_priority %]
          </span>
        </div>

        [%#    Severity    #%]

        <div class="flex-item severity severity-[% bug.bug_severity %]">
          [% INCLUDE "bug/field-label.html.tmpl"
              field = bug_fields.bug_severity
              tag_name = 'b' %]
          <br />
          <span class="select">
            [% INCLUDE bug/field.html.tmpl
              bug = bug, field = bug_fields.bug_severity
              no_tds = 1, value = bug.bug_severity
              override_legal_values = bug.choices.bug_severity
              editable = can_edit_priority %]
          </span>
        </div>
      </div>

      [%#    PRODUCT INFORMATION    #%]

      <div class="bug-row bug-flex">

        [%#    Product    #%]

        <div class="flex-item flex-product">
          [% INCLUDE "bug/field-label.html.tmpl"
              field = bug_fields.product
              tag_name = 'b' %]
          <br />
          <span class="select">
            [% INCLUDE bug/field.html.tmpl
              bug = bug, field = bug_fields.product, value = bug.product
              override_legal_values = bug.choices.product
              desc_url = "describecomponents.cgi"
              editable = bug.check_can_change_field('product', 0, 1)
              no_tds = 1
            %]
          </span>
        </div>

        [%#    Component    #%]

        <div class="flex-item flex-component">
          [% INCLUDE "bug/field-label.html.tmpl"
              field = bug_fields.component
              tag_name = 'b' %]
          <br />
          <div class="flex-split">
            [% INCLUDE bug/field.html.tmpl
              bug = bug, field = bug_fields.component, value = bug.component
              override_legal_values = bug.choices.component
              desc_url = "describecomponents.cgi?product=$bug.product"
              editable = bug.check_can_change_field('component', 0, 1)
              no_tds = 1
            %]
          </div>
        </div>
      </div>

      [%#                #%]
      [%#    COMMENTS    #%]
      [%#                #%]

      <h3>Comments</h3>

      [% IF user.settings.comment_box_position.value == 'before_comments' %]
        [% PROCESS comment_box %]
      [% END %]

      <div id="comments">
        [% PROCESS bug/comments.html.tmpl
          comments = bug.comments
          mode = user.id ? "edit" : "show"
        %]
      </div>

      [% IF user.settings.comment_box_position.value == 'after_comments' %]
        [% PROCESS comment_box %]
      [% END %]
    </div>

    [%#    ----------  SIDEBAR  ----------    #%]

    <div id="bug-sidebar">
      <h3>[% terms.Bug %]&nbsp;#[% bug.bug_id FILTER html %]</h3>
      [% PROCESS reporter %]
      [% PROCESS report_dates %]
      [% PROCESS duplicates %]

      <h3>People</h3>
      [% PROCESS assignee %]
      [% PROCESS qa_contact %]
      [% PROCESS cc_list %]
      [% PROCESS ignore_bug_mail %]

      <h3>Version</h3>
      [% PROCESS version %]
      [% PROCESS target_milestone %]

      <h3>Attachments</h3>
      [% PROCESS attachments %]

      <h3>Additional information</h3>
      <div id="sidebar-expand">
        <a class="action-link expand" onclick="getElementById('sidebar-expand').className='expanded';this.style.display='none';">Show</a>
        [% PROCESS platform %]
        [% PROCESS deadline %]
        [% PROCESS alias %]
        [% PROCESS url %]
        [% PROCESS keywords %]
        [% PROCESS personal_tags %]
        [% PROCESS dependson %]
        [% PROCESS blockedby %]
        [% PROCESS dependencytree %]
        [% PROCESS see_also %]
        [% PROCESS flags %]
        [% PROCESS custom_fields %]
        [% PROCESS restrict_visibility %]
        [% PROCESS timetracking %]
      </div>
  </div>

</div>
</form>

[%#              #%]
[%#    BLOCKS    #%]
[%#              #%]

[%#    Reporter    #%]

[% BLOCK reporter %]
  <div class="field field-reporter">
    <strong>Reported by:</strong><br />
    [% INCLUDE global/user.html.tmpl who = bug.reporter %]<br />
  </div>
[% END %]

[%#    Reporting and modification time and history    #%]

[% BLOCK report_dates %]
  <div class="field field-reportdates">
    <strong>Reported on:</strong> [% bug.creation_ts FILTER time("%Y-%m-%d") %]<br />
    <strong>Last modified on:</strong> [% bug.delta_ts FILTER time("%Y-%m-%d") %]
    <a class="action-link" href="show_activity.cgi?id=[% bug.bug_id %]">Show history</a>
  </div>
[% END %]

[%#    Duplicates    #%]

[% BLOCK duplicates %]
  [% IF bug.duplicates.size %]
    <div class="field field-duplicates">
      <b>Duplicates ([% bug.duplicates.size %]):</b>
      <br />
      <ul>
        [% FOREACH dupe = bug.duplicates %]
          <li>[% INCLUDE bug/link.html.tmpl bug = dupe, link_text = dupe.id, use_alias = 1 %]&nbsp;[% dupe.short_desc %]</li>
        [% END %]
      </ul>
      <br />
      <a href="buglist.cgi?bug_id=[% bug.duplicate_ids.join(",") FILTER html %]" class="action-link">
       [%-%]view as [% terms.bug %] list</a>
    </div>
  [% END %]
[% END %]

[%#    Assignee    #%]

[% BLOCK assignee %]
  <div class="field field-assignee">
    [% can_edit_assigned_to = bug.check_can_change_field("assigned_to", 0, 1) %]
    [% INCLUDE "bug/field-label.html.tmpl"
      field = bug_fields.assigned_to
      tag_name = 'b'
    %]
    <br />
    [% IF can_edit_assigned_to %]
      <div id="bz_assignee_edit_container" class="bz_default_hidden">
        <span>
          [% INCLUDE global/user.html.tmpl who = bug.assigned_to %]
          <a href="#" id="bz_assignee_edit_action" class="action-link">edit</a>
          [% IF bug.assigned_to.id != user.id %]
            <a title="Reassign to yourself" href="#" id="bz_assignee_take_action" class="action-link">take</a>
          [% END %]
        </span>
      </div>
      <div id="bz_assignee_input">
        [% INCLUDE global/userselect.html.tmpl
             id => "assigned_to"
             name => "assigned_to"
             value => bug.assigned_to.login
             classes => ["bz_userfield"]
             size => 30
        %]
        <br />
        <input type="checkbox" id="set_default_assignee" name="set_default_assignee" value="1">
        <label id="set_default_assignee_label" for="set_default_assignee">Reset Assignee to default</label>
      </div>
      <script type="text/javascript">
        hideEditableField('bz_assignee_edit_container',
                          'bz_assignee_input',
                          'bz_assignee_edit_action',
                          'assigned_to',
                          '[% bug.assigned_to.login FILTER js %]' );
        hideEditableField('bz_assignee_edit_container',
                          'bz_assignee_input',
                          'bz_assignee_take_action',
                          'assigned_to',
                          '[% bug.assigned_to.login FILTER js %]',
                          '[% user.login FILTER js %]' );
        initDefaultCheckbox('assignee');
      </script>
    [% ELSE %]
      [% INCLUDE global/user.html.tmpl who = bug.assigned_to %]
    [% END %]
  </div>
[% END %]

[%#    QA Contact    #%]

[% BLOCK qa_contact %]
  [% IF Param('useqacontact') %]
    <div class="field field-qacontact">
      [% can_edit_qa_contact = bug.check_can_change_field("qa_contact", 0, 1) %]
      [% INCLUDE "bug/field-label.html.tmpl"
        field = bug_fields.qa_contact
        accesskey = "q", tag_name = 'b'
      %]
      <br />
      [% IF can_edit_qa_contact %]
        <div id="bz_qa_contact_edit_container" class="bz_default_hidden">
          <span>
            [% IF bug.qa_contact == null %]
              Nobody
            [% ELSE %]
              [% INCLUDE global/user.html.tmpl who = bug.qa_contact %]
            [% END %]
            <a href="#" id="bz_qa_contact_edit_action" class="action-link">edit</a>
            [% IF bug.qa_contact.id != user.id %]
              <a title="Change QA contact to yourself" href="#" id="bz_qa_contact_take_action" class="action-link">take</a>
            [% END %]
          </span>
        </div>
        <div id="bz_qa_contact_input">
          [% INCLUDE global/userselect.html.tmpl
             id      => "qa_contact"
             name    => "qa_contact"
             value   => bug.qa_contact.login
             size    => 30
             classes => ["bz_userfield"]
             emptyok => 1
          %]
          <br />
          <input type="checkbox" id="set_default_qa_contact" name="set_default_qa_contact" value="1">
          <label for="set_default_qa_contact" id="set_default_qa_contact_label">Reset QA Contact to default</label>
        </div>
        <script type="text/javascript">
          hideEditableField('bz_qa_contact_edit_container',
                          'bz_qa_contact_input',
                          'bz_qa_contact_edit_action',
                          'qa_contact',
                          '[% bug.qa_contact.login FILTER js %]');
         hideEditableField('bz_qa_contact_edit_container',
                          'bz_qa_contact_input',
                          'bz_qa_contact_take_action',
                          'qa_contact',
                          '[% bug.qa_contact.login FILTER js %]',
                          '[% user.login FILTER js %]');
         initDefaultCheckbox('qa_contact');
       </script>
      [% ELSE %]
        [% INCLUDE global/user.html.tmpl who = bug.qa_contact %]
      [% END %]
    </div>
  [% END %]
  <script type="text/javascript">
    assignToDefaultOnChange(['product', 'component'],
      '[% bug.component_obj.default_assignee.login FILTER js %]',
      '[% bug.component_obj.default_qa_contact.login FILTER js %]');
  </script>
[% END %]

[%#    CC List    #%]

[% BLOCK cc_list %]
  <div class="field field-cclist">
    <b>CC List:</b>
    <br />
    [% IF user.id %]
      [% IF NOT bug.cc.contains(user.login) %]
        <input type="checkbox" id="addselfcc" name="addselfcc"
          [% " checked=\"checked\""
               IF user.settings.state_addselfcc.value == 'always'
                  || (!bug.user.has_any_role
                      && user.settings.state_addselfcc.value == 'cc_unless_role') %]>
        <label for="addselfcc">Add me to CC list</label>
        <br />
      [% END %]
    [% END %]
    [% bug.cc.size FILTER html %]
    [% IF bug.cc.size == 1 %]
      user
    [% ELSE %]
      users
    [% END %]
    [% IF user.id %]
      [% IF bug.cc.contains( user.email ) %]
        including you
      [% END %]
    [% END %]
    [% IF user.id || bug.cc.size %]
      <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
        <a href="#" id="cc_edit_area_showhide" class="action-link">[% IF user.id %]edit[% ELSE %]show[% END %]</a>
      </span>
    [% END %]
    <div id="cc_edit_area">
      [% IF user.id %]
        <div>
          <div><label for="cc"><b>Add</b></label></div>
          [% INCLUDE global/userselect.html.tmpl
              id => "newcc"
              name => "newcc"
              value => ""
              size => 30
              classes => ["bz_userfield"]
              multiple => 5
            %]
        </div>
      [% END %]
      [% IF bug.cc.size %]
        <select id="cc" multiple="multiple" size="5" [% 'name="cc"' IF bug.user.canedit %]>
          [% FOREACH c = bug.cc %]
            <option value="[% c FILTER email FILTER html %]">
              [% c FILTER email FILTER html %]</option>
          [% END %]
        </select>
        [% IF user.id && !bug.user.canedit %]
          <input type="hidden" name="cc" value="[% user.login FILTER email FILTER html %]">
        [% END %]
        [% IF user.id AND (bug.user.canedit OR bug.cc.contains(user.login)) %]
          <br />
          <input type="checkbox" id="removecc" name="removecc">
          <label for="removecc">
            [% IF bug.user.canedit %]
              Remove selected CCs
            [% ELSE %]
              Remove me from the CC list
            [% END %]
          </label>
          <br />
        [% END %]
      [% END %]
    </div>
    [% IF user.id || bug.cc.size %]
      <script type="text/javascript">
        hideEditableField( 'cc_edit_area_showhide_container',
                           'cc_edit_area',
                           'cc_edit_area_showhide',
                           '',
                           '');
      </script>
    [% END %]
  </div>
[% END %]

[%#    Ignore Bug Mail    #%]

[% BLOCK ignore_bug_mail %]
  [% IF user.id %]
    <div class="field field-ignorebugmail">
      <input type="hidden" name="defined_bug_ignored" value="1">
      <input type="checkbox" name="bug_ignored" id="bug_ignored" value="1"
        [% ' checked="checked"' IF user.is_bug_ignored(bug.id) %]>
      <label for="bug_ignored" title="Ignore all email for this [% terms.bug %]">
        <b>Ignore [% terms.Bug %] Mail</b> (never email me about this [% terms.bug %])
      </label>
    </div>
  [% END %]
[% END %]

[%#    Version    #%]

[% BLOCK version %]
  <div class="field field-version">
    [% INCLUDE "bug/field-label.html.tmpl"
      field = bug_fields.version
      tag_name = 'b' %]
    <br />
    [% PROCESS select selname => "version" %]
  </div>
[% END %]

[%#    Target Milestone    #%]

[% BLOCK target_milestone %]
  [% IF Param("usetargetmilestone") && bug.target_milestone %]
    <div class="field field-targetmilestone">
      [% INCLUDE "bug/field-label.html.tmpl"
        field = bug_fields.target_milestone
        tag_name = 'b'
      %]
      <br />
      [% PROCESS select selname = "target_milestone" %]
    </div>
  [% END %]
[% END %]

[%#    Attachments    Â#%]

[% BLOCK attachments %]
  <div class="field field-attachments">
    [% PROCESS attachment/list.html.tmpl
       attachments = bug.attachments
       bugid       = bug.bug_id
       num_attachment_flag_types = bug.num_attachment_flag_types
       show_attachment_flags = bug.show_attachment_flags
    %]
  </div>
[% END %]

[%#    Platform    #%]

[% BLOCK platform %]
  [% can_edit_rep_platform = bug.check_can_change_field('rep_platform', 0, 1) %]
  <div class="field field-platform">
    [% INCLUDE "bug/field-label.html.tmpl"
      field = bug_fields.rep_platform,
      accesskey = "h", tag_name = 'b' %]
    <br />
    [% INCLUDE bug/field.html.tmpl
        bug = bug, field = bug_fields.rep_platform
        no_tds = 1, value = bug.rep_platform
        override_legal_values = bug.choices.rep_platform
        editable = can_edit_rep_platform %]
    [% INCLUDE bug/field.html.tmpl
        bug = bug, field = bug_fields.op_sys,
        no_tds = 1, value = bug.op_sys
        override_legal_values = bug.choices.op_sys
        editable = bug.check_can_change_field('op_sys', 0, 1) %]
   </div>
[% END %]

[%#    Deadline    #%]

[% BLOCK deadline %]
  [% IF Param("timetrackinggroup") && bug.deadline %]
    <div class="field field-deadline">
      <a href="page.cgi?id=fields.html#deadline">Deadline</a>:
    </div>
    <br />
    [% bug.deadline FILTER html %]
  [% END %]
[% END %]

[%#    Alias    #%]

[% BLOCK alias %]
  <div class="field field-alias">
    [% INCLUDE "bug/field-label.html.tmpl" field = bug_fields.alias, tag_name = 'b' %]
    <br />
    [% IF bug.alias.size %]
      [% bug.alias.join(', ') FILTER html %]
    [% ELSE %]
      None
    [% END %]
    [% IF bug.check_can_change_field('alias', 0, 1) %]
      <span id="alias_edit_area_showhide_container" class="bz_default_hidden">
        <a href="#" class="action-link" id="alias_edit_area_showhide">edit</a>
      </span>
      <br />
      <div id="alias_edit_area">
        <div>
          <label for="newalias" class="field_label">Add</label>
          <br />
          <input name="newalias" id="newalias" size="20">
        </div>
        [% IF bug.alias.size %]
          <select id="alias" name="alias" multiple="multiple" size="5">
            [% FOREACH a = bug.alias %]
              <option value="[% a FILTER html %]">[% a FILTER html %]</option>
            [% END %]
          </select>
          <br />

          <input type="checkbox" id="removealias" name="removealias">
          <label for="removealias">Remove selected aliases</label>
        [% END %]
      </div>
      <script type="text/javascript">
        hideEditableField( 'alias_edit_area_showhide_container',
                           'alias_edit_area',
                           'alias_edit_area_showhide',
                           '',
                           '');
      </script>
    [% END %]
  </div>
[% END %]

[%#    Status Whiteboard    #%]

[% BLOCK status_whiteboard #%]
  [% IF Param('usestatuswhiteboard') %]
    <div class="field field-statuswhiteboard">
      [% INCLUDE "bug/field-label.html.tmpl"
        field = bug_fields.status_whiteboard
        accesskey = "w", tag_name = 'b'
      %]
      <br />
      [% INCLUDE input inputname = "status_whiteboard" size = 40 %]
    </div>
  [% END %]
[% END %]

[%#    URL    #%]

[% BLOCK url #%]
  <div class="field field-url">
    [% can_edit_bug_file_loc = bug.check_can_change_field("bug_file_loc", 0, 1) %]
    [% INCLUDE "bug/field-label.html.tmpl"
      field = bug_fields.bug_file_loc
      accesskey = "u", tag_name = 'b'
    %]
    <br />

    [% IF can_edit_bug_file_loc %]
      <span id="bz_url_edit_container" class="bz_default_hidden"> 
      [% IF is_safe_url(bug.bug_file_loc) %]
        <a href="[% bug.bug_file_loc FILTER html %]" target="_blank"
           rel="noreferrer" title="[% bug.bug_file_loc FILTER html %]">
           [% bug.bug_file_loc FILTER truncate(40) FILTER html %]</a>
      [% ELSE %]
        [% bug.bug_file_loc FILTER html %]
      [% END %]
      <a href="#" class="action-link" id="bz_url_edit_action">edit</a></span>
    [% END %]
    <span id="bz_url_input_area">
      [% url_output = INCLUDE input no_td = 1 inputname = "bug_file_loc" size = 40 %]
      [% IF NOT bug.check_can_change_field("bug_file_loc", 0, 1)
            AND is_safe_url(bug.bug_file_loc) %]
        <a href="[% bug.bug_file_loc FILTER html %]"
           rel="noreferrer">[% url_output FILTER none %]</a>
      [% ELSE %]
        [% url_output FILTER none %]
      [% END %]
    </span>
    [% IF bug.check_can_change_field("bug_file_loc", 0, 1) %]
      <script type="text/javascript">
        hideEditableField('bz_url_edit_container', 
                          'bz_url_input_area', 
                          'bz_url_edit_action', 
                          'bug_file_loc', 
                          "[% bug.bug_file_loc FILTER js %]");
      </script>
    [% END %]
  </div>
[% END %]

[%#    Keywords    #%]

[% BLOCK keywords %]
  [% IF use_keywords %]
    <div class="field field-keywords">
      [% INCLUDE "bug/field-label.html.tmpl" field = bug_fields.keywords, tag_name = 'b' %]
      <br />
      [% INCLUDE bug/field.html.tmpl
        bug = bug, field = bug_fields.keywords, value = bug.keywords
        editable = bug.check_can_change_field("keywords", 0, 1),
        desc_url = "describekeywords.cgi", possible_values = all_keywords,
        no_label = 1
      %]
    </div>
  [% END %]
[% END %]

[%#    Personal Tags    #%]

[% BLOCK personal_tags %]
  [% IF user.id %]
    <div class="field field-personaltags">
      [% INCLUDE "bug/field-label.html.tmpl" field = bug_fields.tag, tag_name = 'b' %]
      <br />
      [% INCLUDE bug/field.html.tmpl
        bug = bug, field = bug_fields.tag, value = bug.tags.join(", "),
        editable = 1, possible_values = user.tags.keys, no_label = 1
      %]
    </div>
  [% END %]
[% END %]

[%#    Depends On    #%]

[% BLOCK dependson %]
  <div class="field field-dependson">
    [% INCLUDE dependencies 
       field = bug_fields.dependson deps = bug.depends_on_obj, tag_name = 'b' %]
  </div>
[% END %]

[%#    Blocked By    #%]

[% BLOCK blockedby %]
  <div class="field field-blockedby">
    [% INCLUDE dependencies 
      field = bug_fields.blocked deps = bug.blocks_obj, tag_name = 'b' %]
  </div>
[% END %]

[%#    Dependency tree/chart    #%]

[% BLOCK dependencytree %]
  [% IF bug.dependson.size || bug.blocked.size %]
    <div class="field field-dependencytree" id="show_dependency_tree_or_graph">
      Show dependency <a href="showdependencytree.cgi?id=[% bug.bug_id %]&amp;hide_resolved=1">tree</a>
      [% IF Param('webdotbase') %]
        /&nbsp;<a href="showdependencygraph.cgi?id=[% bug.bug_id %]">graph</a>
      [% END %]
    </div>
  [% END %]
[% END %]

[%#    See Also    #%]
[% BLOCK see_also %]
  [% IF Param('use_see_also') || bug.see_also.size %]
    <div class="field field-seealso">
      [% INCLUDE "bug/field-label.html.tmpl" field = bug_fields.see_also, tag_name = 'b' %]<br />
      [% INCLUDE bug/field.html.tmpl 
           field    = bug_fields.see_also
           value    = bug.see_also
           editable = bug.check_can_change_field('see_also', 0, 1)
      %]
    </div>
  [% END %]
[% END %]

[%#    Flags    #%]

[% BLOCK flags %]
  [% show_bug_flags = 0 %]
  [% bug_flags_set = 0 %]
  [% show_more_flags = 0 %]
  [% FOREACH type = bug.flag_types %]
    [% IF type.flags.size || (user.id && type.is_active && user.can_request_flag(type)) %]
      [% show_bug_flags = 1 %]
    [% END %]
    [% IF user.id && type.is_active && (!type.flags.size || type.is_multiplicable) %]
      [% show_more_flags = 1 %]
    [% END %]
    [% IF type.flags.size %]
      [% bug_flags_set = 1 %]
    [% END %]
    [% LAST IF show_bug_flags && show_more_flags && bug_flags_set %]
  [% END %]
  [% IF show_bug_flags %]
    <div class="field field-flags">
      [% IF bug.flag_types.size %]
        [% PROCESS "flag/list.html.tmpl" flag_no_header = 1
                                         flag_types = bug.flag_types
                                         any_flags_requesteeble = bug.any_flags_requesteeble %]
      [% END %]
      [% IF show_more_flags %]
        <span id="bz_flags_more_container" class="bz_default_hidden">
          [% IF !bug_flags_set %]<em>None yet set</em>[% END %]
          <a class="action-link" href="#" id="bz_flags_more_action">[% IF !bug_flags_set %]set[% ELSE %]more[% END %] flags</a>
        </span>
        <script type="text/javascript">
          YAHOO.util.Dom.removeClass('bz_flags_more_container', 'bz_default_hidden');
          var table = YAHOO.util.Dom.get("flags");
          var rows = YAHOO.util.Dom.getElementsByClassName('bz_flag_type', 'tbody', table);
          for (var i = 0; i < rows.length; i++) {
              YAHOO.util.Dom.addClass(rows[i], 'bz_default_hidden');
          }
          YAHOO.util.Event.addListener('bz_flags_more_action', 'click', function (e) {
              YAHOO.util.Dom.addClass('bz_flags_more_container', 'bz_default_hidden');
              for (var i = 0; i < rows.length; i++) {
                  YAHOO.util.Dom.removeClass(rows[i], 'bz_default_hidden');
              }
              YAHOO.util.Event.preventDefault(e);
          }); 
        </script>
      [% END %]
    </div>
  [% END %]
[% END %]

[%#    Restrict visibility    %]

[% BLOCK restrict_visibility %]
  [% RETURN UNLESS bug.groups.size %]

  <div class="field field-restrictvisibility">
    <div class="bz_group_visibility_section">
      [% inallgroups = 1 %]
      [% inagroup = 0 %]
      [% emitted_description = 0 %]

      [% FOREACH group = bug.groups %]
        [% SET inallgroups = 0 IF NOT group.ingroup %]
        [% SET inagroup = 1 IF group.ison %]

        [% NEXT IF group.mandatory %]

        [% IF NOT emitted_description %]
          [% emitted_description = 1 %]
            <div id="bz_restrict_group_visibility_help">
              <b>Only users in
                [%+ IF Param('or_groups') %]at least one[% ELSE %]all[% END %]
                of the selected groups can view this [% terms.bug %]:</b>
               <p class="instructions">
                 Unchecking all boxes makes this a more public [% terms.bug %].
               </p>
            </div>
        [% END %]

        [% IF group.ingroup %]
          <input type="hidden" name="defined_groups" 
                 value="[% group.name FILTER html %]">
        [% END %]

        <input type="checkbox" value="[% group.name FILTER html %]"
               name="groups" id="group_[% group.bit %]"
               [% ' checked="checked"' IF group.ison %]
               [% ' disabled="disabled"' IF NOT group.ingroup %]>
        <label for="group_[% group.bit %]">
        [%- group.description FILTER html_light %]</label>
        <br />
      [% END %]

      [% IF emitted_description %]
        [% IF NOT inallgroups %]
          <p class="instructions">Only members of a group can change the 
            visibility of [% terms.abug %] for that group.</p>
        [% END %]
      [% END %]

      [% IF inagroup %]
        <div id="bz_enable_role_visibility_help">
          <b>Users in the roles selected below can always view 
            this [% terms.bug %]:</b>
        </div>
        <div id="bz_enable_role_visibility">
          <div>
            [% user_can_edit_accessible = 
              bug.check_can_change_field("reporter_accessible", 0, 1) 
            %]
            [% IF user_can_edit_accessible %]
              <input type="hidden" name="defined_reporter_accessible" value="1">
            [% END %]
            <input type="checkbox" value="1"
                   name="reporter_accessible" id="reporter_accessible"
                   [% " checked" IF bug.reporter_accessible %]
                   [% " disabled=\"disabled\"" UNLESS user_can_edit_accessible %]>
            <label for="reporter_accessible">Reporter</label>
          </div>
          <div>
            [% user_can_edit_accessible = 
              bug.check_can_change_field("cclist_accessible", 0, 1) 
            %]
            [% IF user_can_edit_accessible %]
              <input type="hidden" name="defined_cclist_accessible" value="1">
            [% END %]
            <input type="checkbox" value="1"
                   name="cclist_accessible" id="cclist_accessible"
                   [% " checked" IF bug.cclist_accessible %]
                   [% " disabled=\"disabled\"" UNLESS user_can_edit_accessible %]>
            <label for="cclist_accessible">CC List</label>
          </div>
          <p class="instructions">
            The assignee
            [% IF (Param('useqacontact')) %]
               and QA contact
            [% END %]
            can always see [% terms.abug %], and this section does not
            take effect unless the [% terms.bug %] is restricted to at
            least one group.
          </p>
        </div>
      [% END %]
    </div> [%# bz_group_visibility_section %]
  </div>
[% END %]

[%#    Time Tracking    #%]

[% BLOCK timetracking %]
  [% IF user.is_timetracker %]
    <div class="field field-timetracking"
      <table class="bz_time_tracking_table">
        <tr>
          [% INCLUDE "bug/field-label.html.tmpl"
            field = bug_fields.estimated_time
          %]
          <th>
            Current Est.:
          </th>
          [% INCLUDE "bug/field-label.html.tmpl"
             field = bug_fields.work_time
          %]
          [% INCLUDE "bug/field-label.html.tmpl"
             field = bug_fields.remaining_time
          %]
          [% INCLUDE "bug/field-label.html.tmpl"
             field = bug_fields.percentage_complete
          %]
          <th>
            Gain:
          </th>
          [% INCLUDE "bug/field-label.html.tmpl"
             field = bug_fields.deadline
          %]
        </tr>
        <tr>
          <td>
            <input name="estimated_time" id="estimated_time"
                   value="[% PROCESS formattimeunit
                                     time_unit=bug.estimated_time %]"
                   size="6" maxlength="6">
          </td>
          <td>
            [% PROCESS formattimeunit
                       time_unit=(bug.actual_time + bug.remaining_time) %]
          </td>
          <td>
            [% PROCESS formattimeunit time_unit=bug.actual_time %] +
            <input name="work_time" id="work_time"
                   value="0" size="3" maxlength="6"
                   onchange="adjustRemainingTime();">
          </td>
          <td>
            <input name="remaining_time" id="remaining_time"
                   value="[% PROCESS formattimeunit
                                     time_unit=bug.remaining_time %]"
                   size="6" maxlength="6" onchange="updateRemainingTime();">
          </td>
          <td>
            [% PROCESS calculatepercentage act=bug.actual_time
                                           rem=bug.remaining_time %]
          </td>
          <td>
            [% PROCESS formattimeunit time_unit=bug.estimated_time - (bug.actual_time + bug.remaining_time) %]
          </td>
          <td>
            [% INCLUDE bug/field.html.tmpl
              field = bug_fields.deadline, value = bug.deadline, no_tds = 1
              editable = bug.check_can_change_field('deadline', 0, 1) %]
          </td>        
        </tr>
        <tr>
          <td colspan="7" class="bz_summarize_time">
            <a href="summarize_time.cgi?id=[% bug.bug_id %]&amp;do_depends=1">
            Summarize time (including time for [% terms.bugs %]
            blocking this [% terms.bug %])</a>
          </td>
        </tr>
      </table> 
    </div>
  [% END %]
[% END %]

[%#    Custom fields    #%]

[% BLOCK custom_fields %]
  [% USE Bugzilla %]
  [% FOREACH field = Bugzilla.active_custom_fields %]
    <div class="field field.[% field.name FILTER html %]">
      [%# Use PROCESS instead of INCLUDE, because extra_field_item is defined
        # in the template and must be returned back. INCLUDE cannot do that. %]
      [% PROCESS bug/field.html.tmpl value = bug.${field.name}
                                     editable = bug.check_can_change_field(field.name, 0, 1) %]
      [% IF extra_field_item %]
        <br />
        <strong>[% extra_field_item.header FILTER none %]</strong>
        <br />
        [% extra_field_item.data FILTER none %]
      [% END %]
    </div>
  [% END %]
  [% Hook.process("after_custom_fields") %]
[% END %]


[%# TBD #%]

[%############################################################################%]
[%# Block for the Additional Comments box                                    #%]
[%############################################################################%]

[% BLOCK comment_box %]
  <div id="add_comment" class="bz_section_additional_comments">
    [% IF user.id %]
<!--      <label for="comment" accesskey="c"><b>Additional 
        <u>C</u>omments</b></label>: -->

      [% IF user.is_insider && bug.check_can_change_field('longdesc', 0, 1) %]
        <input type="checkbox" name="comment_is_private" value="1"
               id="newcommentprivacy"
               onClick="updateCommentTagControl(this, 'comment')">
        <label for="newcommentprivacy">
          Make comment private (visible only to members of the
          <strong>[% Param('insidergroup') FILTER html %]</strong> group)
        </label>
      [% END %]

      <!-- This table keeps the submit button aligned with the box. -->
      <table><tr><td>
        [% IF bug.check_can_change_field('longdesc', 0, 1) %]
          [% INCLUDE bug/comment.html.tmpl
                     minrows   = 10
                     maxrows   = 25
                     cols      = constants.COMMENT_COLS
          %]
          [% IF user.is_insider %]
            <script>
               updateCommentTagControl(document.getElementById('newcommentprivacy'), 'comment');
            </script>
          [% END %]
          [% Hook.process("after_comment_textarea", 'bug/edit.html.tmpl') %]
        [% ELSE %]
          You are not allowed to make an additional comment on this [% terms.bug %].
        [% END %]
        [% PROCESS commit_button id=""%]

        [% Hook.process("after_comment_commit_button", 'bug/edit.html.tmpl') %]

      </td></tr></table>

    [%# For logged-out users %]
    [% ELSE %]
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=
                      [%- bug.bug_id %]&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this [% terms.bug %].
            </fieldset>
          </td>
        </tr> 
      </table>
    [% END %]
  </div>
[% END %]

[%############################################################################%]
[%# Block for SELECT fields                                                  #%]
[%############################################################################%]

[% BLOCK select %]
  [% IF bug.check_can_change_field(selname, 0, 1) 
        AND bug.choices.${selname}.size > 1 %]
    <input type="hidden" id="[% selname %]_dirty">
    <select id="[% selname %]" name="[% selname %]">
      [% FOREACH x = bug.choices.${selname} %]
        <option value="[% x.name FILTER html %]"
          [% " selected" IF x.name == bug.${selname} %]>
          [%- x.name FILTER html %]
        </option>
      [% END %]
    </select>
  [% ELSE %]
    [% bug.${selname} FILTER html %]
  [% END %]
[% END %]

[%############################################################################%]
[%# Block for INPUT fields                                                   #%]
[%############################################################################%]

[% BLOCK input %]
  [% IF no_td != 1 %]
  <td[% " colspan=\"$colspan\"" IF colspan %]>
  [% END %]
    [% val = value ? value : bug.$inputname %]
    [% IF bug.check_can_change_field(inputname, 0, 1) %]
       <input id="[% inputname %]" name="[% inputname %]" class="text_input"
              value="[% val FILTER html %]"[% " size=\"$size\"" IF size %]
              [% " maxlength=\"$maxlength\"" IF maxlength %]
              [% " spellcheck=\"$spellcheck\"" IF spellcheck %]>
    [% ELSE %]
      [% IF size && val.length > size %]
        <span title="[% val FILTER html %]">
          [% val FILTER truncate(size) FILTER html %]
        </span>
      [% ELSE %]
        [% val FILTER html %]
      [% END %]
    [% END %]
  [% IF no_td != 1 %]  
  </td>
  [% END %]
  [% no_td = 0 %]
  [% maxlength = 0 %]
  [% colspan = 0 %]
  [% size = 0 %]
  [% value = undef %]
  [% spellcheck = undef %]
[% END %]

[%# Commit button... %]
[% BLOCK commit_button %]
  [% IF user.id %]
    <div class="knob-buttons">
      [% IF id == '_top' && bug.check_can_change_field('short_desc', 0, 1) %]
        <a href="#" id="summary_edit_action" class="action-link">Edit title</a>
      [% END %]
      <input type="submit" value="Save Changes" 
             id="commit[% id FILTER css_class_quote %]">
    </div>
  [% END %]
[% END %]

[%############################################################################%]
[%# Block for dependencies                                                   #%]
[%############################################################################%]

[% BLOCK dependencies %]

  [% INCLUDE "bug/field-label.html.tmpl" %]

  <td>
    <span id="[% field.name FILTER html %]_input_area">
      [% IF bug.check_can_change_field(field.name, 0, 1) %]
        <input name="[% field.name FILTER html %]" 
               id="[% field.name FILTER html %]" class="text_input"
               value="[% bug.${field.name}.join(', ') FILTER html %]">
      [% END %]
    </span>

    [% FOREACH dep_bug = deps %]
      [% INCLUDE bug/link.html.tmpl bug = dep_bug, link_text = dep_bug.id, use_alias = 1 %][% " " %]
    [% END %]
    [% IF bug.check_can_change_field(field.name, 0, 1) %]
      <span id="[% field.name FILTER html %]_edit_container" 
            class="edit_me bz_default_hidden">
        (<a href="#" id="[% field.name FILTER html %]_edit_action">edit</a>)
      </span>
      <script type="text/javascript">
        hideEditableField('[% field.name FILTER js %]_edit_container', 
                          '[% field.name FILTER js %]_input_area', 
                          '[% field.name FILTER js %]_edit_action', 
                          '[% field.name FILTER js %]', 
                          '[% bug.${field.name}.join(', ') FILTER js %]');
      </script>
    [% END %]
  </td>
  
[% END %]

